------------------------------------------------------------------
-- 1] Initiates the survival Stats, ONLY in Survival games		--
-- 2] Enables/Disables unlimited turrets for Survival/Normal	--
--     ... games, respectively									--
-- Made by Gambit @ 20/8/2017. Updated 26/1/2018				--
------------------------------------------------------------------

import("WXPScarUtil.scar")
import("WCUtil.scar")
import("Community_Functions.scar")


function SurvivalFix_OnInit()
print("Turret Step 1")
	-- First, disallow the optional turrets, if any for the race
	for idx = 0, World_GetPlayerCount()-1 do
		local playerID = World_GetPlayerAt(idx)
		local race_name = Player_GetRaceName(playerID)
		if Global_RaceStats[race_name].Turret_Special ~= nil then
			Player_RestrictBuildingList(playerID, Global_RaceStats[race_name].Turret_Special)
		end
	end

	local max_slot = World_GetPlayerCount()-1

	if G_Is_Survival_Map == true then -- Survival map, disallow standard defences for players only
	-- Survival Game
		-- First, create the GLOBAL array witgh Survival Player stats - each entry uses the IDX of the player (0,1,..7)
		Srvl_PlayerInfo = { IsAlive={}, PlayerID={}, RaceName={}, PlayerName={}, HQpos={}, HQName={}, LPName={}, CmndrEntName={}, CmndrSqdName={}, PriBuilderSqdName={}, TurretSndrdName={}, TurretNoLimName={}, TurretSpecialName={}, MinesName={}, Thermo={}, SurvMinesName={}, Techlvl={}, Tech2Info={}, Tech3Info={}, Tech4Info={},TechA2Info={}, TechA3Info={}, TechA4Info={}, Tech1Bonus={}, Tech2Bonus={}, Tech3Bonus={}, Tech4Bonus={}, TechUberBonus={}, Level={}, TMR = {}, LvlSwitch={}, IsVanilla = {}, AircraftName = {} }

		-- 1] Calculate player stats, and populate the Array!!! The last player (max_slot) will ALWAYS be the Attacking AI
		for i = 0, max_slot do
			local player_id = World_GetPlayerAt(i)
			local race_name = Player_GetRaceName(player_id)
			local enemy_ai_player = (i == max_slot)
			if Global_RaceStats[race_name] ~= nil then
				Srvl_PlayerInfo.IsAlive[i] = true
				Srvl_PlayerInfo.PlayerID[i] = player_id
				Srvl_PlayerInfo.RaceName[i] = race_name
				Srvl_PlayerInfo.PlayerName[i] = Player_GetDisplayName(player_id)[1]
				Srvl_PlayerInfo.HQpos[i] = Player_GetStartPosition(player_id)
				Srvl_PlayerInfo.HQName[i] = Global_RaceStats[race_name].HQ
				Srvl_PlayerInfo.LPName[i] = Global_RaceStats[race_name].LP
				Srvl_PlayerInfo.PriBuilderSqdName[i] = Global_RaceStats[race_name].BuilderSquad
				Srvl_PlayerInfo.TurretSndrdName[i] = Global_RaceStats[race_name].Turret
				Srvl_PlayerInfo.TurretNoLimName[i] = Global_RaceStats[race_name].Turret_Srvl
				Srvl_PlayerInfo.AircraftName[i] = Global_RaceStats[race_name].FlyerSquads
				if Global_RaceStats[race_name].Turret_Special ~= nil then
					Srvl_PlayerInfo.TurretSpecialName[i] = Global_RaceStats[race_name].Turret_Special
				else
					Srvl_PlayerInfo.TurretSpecialName[i] = {}
				end
				Srvl_PlayerInfo.Thermo[i] = Global_RaceStats[race_name].Thermo
				Srvl_PlayerInfo.MinesName[i] = Global_RaceStats[race_name].Mine
				Srvl_PlayerInfo.SurvMinesName[i] = Global_RaceStats[race_name].Mine_Srvl
				Srvl_PlayerInfo.Techlvl[i] = 1
					Srvl_PlayerInfo.TechA2Info[i] = Global_RaceStats[race_name].Tier2A
					Srvl_PlayerInfo.TechA3Info[i] = Global_RaceStats[race_name].Tier3A
					Srvl_PlayerInfo.TechA4Info[i] = Global_RaceStats[race_name].Tier4A
					Srvl_PlayerInfo.Tech2Info[i] = Global_RaceStats[race_name].Tier2
					Srvl_PlayerInfo.Tech3Info[i] = Global_RaceStats[race_name].Tier3
					Srvl_PlayerInfo.Tech4Info[i] = Global_RaceStats[race_name].Tier4

				Srvl_PlayerInfo.Tech1Bonus[i] = Global_RaceStats[race_name].Tech1BonusSquads_Srvl
				Srvl_PlayerInfo.Tech2Bonus[i] = Global_RaceStats[race_name].Tech2BonusSquads_Srvl
				Srvl_PlayerInfo.Tech3Bonus[i] = Global_RaceStats[race_name].Tech3BonusSquads_Srvl
				Srvl_PlayerInfo.Tech4Bonus[i] = Global_RaceStats[race_name].Tech4BonusSquads_Srvl
				Srvl_PlayerInfo.TechUberBonus[i] = Global_RaceStats[race_name].Tech4BonusUberSquads_Srvl
				Srvl_PlayerInfo.Level[i] = 1
				Srvl_PlayerInfo.TMR[i] = 0
				Srvl_PlayerInfo.LvlSwitch[i] = -1
				Srvl_PlayerInfo.IsVanilla[i] = Global_RaceStats[race_name].IsVanilla
				if Srvl_PlayerInfo.IsVanilla[i] == true then 
					if Is_Hero_Wargear_Enabled_Survival ~= nil and not enemy_ai_player then
						if race_name == "necron_race" then
							if g_Necrons_PlayersIDXs[i] == 1 then
								Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity_WG4
								Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad_WG4
								g_Necrons_PlayersIDXs[i] = 4
							elseif g_Necrons_PlayersIDXs[i] == 2 then
								Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity_WG5
								Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad_WG5
								g_Necrons_PlayersIDXs[i] = 5
							elseif g_Necrons_PlayersIDXs[i] == 3 then
								Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity_WG6
								Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad_WG6
								g_Necrons_PlayersIDXs[i] = 6
							end
						else
							Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity_WG
							Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad_WG
						end
					else
						if race_name == "necron_race" then
							if g_Necrons_PlayersIDXs[i] == 1 then
								Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity1
								Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad1
							elseif g_Necrons_PlayersIDXs[i] == 2 then
								Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity2
								Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad2
							elseif g_Necrons_PlayersIDXs[i] == 3 then
								Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity3
								Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad3
							end
						else
							Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity
							Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad
						end
					end
				else
					Srvl_PlayerInfo.CmndrEntName[i] = Global_RaceStats[race_name].CommanderEntity
					Srvl_PlayerInfo.CmndrSqdName[i] = Global_RaceStats[race_name].CommanderSquad
				end
			else
				print("Unsupported Survival Player Race: "..race_name.." !!!")
				g_Surv_Unsupported_Race = race_name
			end
		end
	end
end


Scar_AddInit(SurvivalFix_OnInit)
